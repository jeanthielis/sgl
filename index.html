<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGL - Sistema de Gestão de Liderança</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* --- ESTILOS GERAIS (Mantidos) --- */
        :root {
            --bg-body: #f8fafc; --bg-sidebar: linear-gradient(180deg, #0369a1 0%, #0c4a6e 100%);
            --bg-card: #ffffff; --bg-input: #ffffff; --text-primary: #1e293b; --text-secondary: #64748b;
            --text-sidebar: #ffffff; --border-color: #e2e8f0; --primary: #0ea5e9; --primary-hover: #0284c7;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode {
            --bg-body: #0f172a; --bg-sidebar: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            --bg-card: #1e293b; --bg-input: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
            --text-sidebar: #e2e8f0; --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5); --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; }
        
        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--bg-sidebar); color: var(--text-sidebar); display: flex; flex-direction: column; box-shadow: var(--shadow-lg); z-index: 10; }
        .logo-container { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 18px; }
        .nav-menu { flex: 1; padding: 20px 0; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 24px; color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; }
        .nav-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background-color: rgba(255,255,255,0.15); color: white; border-right: 3px solid var(--primary); }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { background-color: var(--bg-card); padding: 16px 24px; box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 20px; font-weight: 600; }
        .content-area { flex: 1; padding: 24px; overflow-y: auto; }
        .card { background-color: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); margin-bottom: 24px; overflow: hidden; }
        .card-header { padding: 20px; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 18px; }
        .card-body { padding: 20px; }
        
        /* Componentes */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-outline { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { background-color: #f1f5f9; }
        body.dark-mode .btn-outline:hover { background-color: #334155; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .form-control { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); margin-bottom: 15px; }
        
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border-color); color: var(--text-secondary); }
        .table td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        
        .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; gap: 15px; z-index: 100; }
        .fab { width: 56px; height: 56px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: var(--shadow-lg); color: white; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); }
        .fab-add { background-color: var(--primary); }
        .fab-theme { background-color: var(--text-primary); color: var(--bg-body); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: var(--bg-card); width: 90%; max-width: 500px; padding: 24px; border-radius: 16px; box-shadow: var(--shadow-lg); max-height: 90vh; overflow-y: auto; }
        
        .score-display { text-align: center; padding: 20px; background: linear-gradient(135deg, var(--primary) 0%, #0369a1 100%); border-radius: 16px; color: white; margin-bottom: 20px; }
        .score-value { font-size: 56px; font-weight: 700; line-height: 1; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; margin-bottom: 30px; }
        
        .badge-points { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px; }
        .bg-success { background-color: rgba(16, 185, 129, 0.2); color: #10b981; }
        .bg-danger { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .bg-gray { background-color: rgba(100, 116, 139, 0.2); color: var(--text-secondary); }
        .history-date { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .toggle-type { display: flex; margin-bottom: 15px; background: var(--border-color); padding: 4px; border-radius: 8px; }
        .toggle-option { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-weight: 500; }
        .toggle-option.active { background: var(--bg-card); box-shadow: var(--shadow-sm); }
        .toggle-option.active.negativo { color: var(--danger); border-left: 3px solid var(--danger); }
        .toggle-option.active.positivo { color: var(--success); border-left: 3px solid var(--success); }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Novo estilo para checkbox de desativar penalidade */
        .checkbox-container {
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px; 
            background: var(--bg-input); padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;
        }
        .checkbox-container input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); }

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary); animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p>Conectando ao banco de dados...</p>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo"><i class="fas fa-chart-line"></i> SGL Online</div>
            </div>
            <nav class="nav-menu">
                <a class="nav-item active" onclick="switchTab('ocorrencias', this)"><i class="fas fa-list"></i> Ocorrências</a>
                <a class="nav-item" onclick="switchTab('historico', this)"><i class="fas fa-history"></i> Histórico</a>
                <a class="nav-item" onclick="switchTab('resultado', this)"><i class="fas fa-trophy"></i> Resultado</a>
                <a class="nav-item" onclick="switchTab('configuracoes', this)"><i class="fas fa-cogs"></i> Configurações</a>
                <a class="nav-item" onclick="switchTab('lideres', this)"><i class="fas fa-users"></i> Líderes</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1 class="header-title" id="pageTitle">Ocorrências</h1>
                <div><span id="currentDate" style="font-size: 14px; color: var(--text-secondary);"></span></div>
            </header>

            <div class="content-area">
                
                <div id="ocorrencias" class="tab-content active">
                    <div class="card">
                        <div class="card-header">Registros de Hoje</div>
                        <div class="card-body">
                            <div id="listaOcorrenciasHoje"></div>
                            <div id="emptyState" style="text-align: center; padding: 40px; color: var(--text-secondary); display: none;">
                                <i class="fas fa-clipboard-check" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                                <p>Nenhum registro hoje.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="historico" class="tab-content">
                    <div class="card">
                        <div class="card-header">Extrato Detalhado</div>
                        <div class="card-body">
                            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                                <select id="histLider" class="form-control" style="flex: 2; min-width: 200px;"></select>
                                <select id="histAno" class="form-control" style="flex: 1; min-width: 100px;"></select>
                                <select id="histMes" class="form-control" style="flex: 1; min-width: 150px;">
                                    <option value="todos">Ano Completo</option>
                                    <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option>
                                    <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
                                    <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
                                    <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div id="listaHistorico"></div>
                            <div id="emptyStateHist" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                                <p>Sem registros para o filtro.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="resultado" class="tab-content">
                    <div class="card">
                        <div class="card-header">Desempenho</div>
                        <div class="card-body">
                            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                                <select id="resLider" class="form-control" style="flex: 2; min-width: 200px;"></select>
                                <select id="resAno" class="form-control" style="flex: 1; min-width: 100px;"></select>
                                <select id="resPeriodo" class="form-control" style="flex: 1; min-width: 150px;">
                                    <option value="anual">Anual (Meta 1200)</option>
                                    <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option>
                                    <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
                                    <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
                                    <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="score-display">
                                <div class="score-value" id="displayPontos">--</div>
                                <div class="score-label" id="displayMeta">Selecione um líder</div>
                            </div>
                            <div class="chart-container"><canvas id="graficoResultado"></canvas></div>
                            <h3>Detalhamento</h3>
                            <table class="table" id="tabelaExtrato"><thead><tr><th>Regra</th><th>Qtd/Valor</th><th>Impacto</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="configuracoes" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span>Regras e Pesos</span>
                                <button class="btn btn-primary btn-sm" onclick="abrirModalRegra()">+ Nova Regra</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="table" id="tabelaRegras">
                                <thead><tr><th>Ativa</th><th>Nome</th><th>Configuração</th><th>Peso</th><th>Ação</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                 <div id="lideres" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span>Equipe de Líderes</span>
                                <button class="btn btn-primary btn-sm" onclick="abrirModalLider()">+ Novo Líder</button>
                            </div>
                        </div>
                        <div class="card-body"><div id="listaLideresGerenciar"></div></div>
                    </div>
                </div>
            </div>
        </main>

        <div class="fab-container">
            <button class="fab fab-theme" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            <button class="fab fab-add" onclick="abrirModalOcorrencia()"><i class="fas fa-plus"></i></button>
        </div>
    </div>

    <div id="modalOcorrencia" class="modal">
        <div class="modal-content">
            <h3>Nova Ocorrência</h3><br>
            <label>Líder</label><select id="inputLider" class="form-control"></select>
            <label>Tipo</label><select id="inputRegra" class="form-control"></select>
            <p id="descRegra" style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;"></p>
            
            <div id="divValorReal" style="display: none; background: var(--bg-body); padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--primary);">
                <label style="color: var(--primary); font-weight: bold;">Valor Real Atingido</label>
                <input type="number" id="inputValorReal" class="form-control" placeholder="Ex: 92">
                <small>Meta: <span id="spanMetaAlvo"></span></small>
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="checkIgnorar">
                <label for="checkIgnorar" style="cursor: pointer; margin:0;">Desativar Penalidade (Apenas Registro)</label>
            </div>

            <label>Data</label><input type="date" id="inputData" class="form-control">
            <label>Obs</label><textarea id="inputObs" class="form-control" rows="2"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" style="flex:1" onclick="fecharModais()">Cancelar</button>
                <button class="btn btn-primary" style="flex:1" onclick="salvarOcorrencia()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalRegra" class="modal">
        <div class="modal-content">
            <h3>Configurar Regra</h3><br>
            <label>Nome da Regra</label><input type="text" id="regraNome" class="form-control" placeholder="Ex: Nota de Limpeza">
            
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>Peso (Pontos)</label>
                    <input type="number" id="regraPeso" class="form-control" placeholder="5">
                </div>
                <div style="flex: 1;">
                    <label>Meta / Alvo</label>
                    <input type="number" id="regraMeta" class="form-control" value="0">
                </div>
            </div>
            <small style="display: block; margin-bottom: 15px; color: var(--text-secondary); line-height: 1.3;">
                <b>Se Meta = 0:</b> Usa o tipo Padrão abaixo.<br>
                <b>Se Meta > 0:</b> Acima da meta ganha ponto, abaixo perde.
            </small>

            <label>Tipo Padrão (Se não houver Meta)</label>
            <div class="toggle-type">
                <div class="toggle-option active negativo" id="btnTypeNeg" onclick="setRegraType('negativo')">Penalidade</div>
                <div class="toggle-option" id="btnTypePos" onclick="setRegraType('positivo')">Bonificação</div>
            </div>
            
            <label>Limite de Qtd (Opcional)</label><input type="number" id="regraLimite" class="form-control" value="0">

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" style="flex:1" onclick="fecharModais()">Cancelar</button>
                <button class="btn btn-primary" style="flex:1" onclick="salvarRegra()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalLider" class="modal">
        <div class="modal-content">
            <h3 id="tituloModalLider">Cadastrar Líder</h3><br>
            <input type="hidden" id="editLiderId"> <label>Nome Completo</label><input type="text" id="novoLiderNome" class="form-control">
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" style="flex:1" onclick="fecharModais()">Cancelar</button>
                <button class="btn btn-primary" style="flex:1" onclick="salvarLider()">Salvar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } 
        from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

        // ==========================================================
        // COLE SUAS CHAVES DO FIREBASE AQUI
        // ==========================================================
        const firebaseConfig = {
  apiKey: "AIzaSyCSq4Aur-1RiDLobPT14TjkAWQ1o98wBfQ",
  authDomain: "sgl-lideranca.firebaseapp.com",
  projectId: "sgl-lideranca",
  storageBucket: "sgl-lideranca.firebasestorage.app",
  messagingSenderId: "866968216553",
  appId: "1:866968216553:web:e512e36f620ed58ac72178",
  measurementId: "G-5278BYMHNY"
};

        let app, db;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); } 
        catch (e) { console.error(e); alert("Erro Config Firebase"); }

        let lideres = [], ocorrencias = [], regras = [], regraTipoAtual = 'negativo';
        let isDarkMode = localStorage.getItem('theme') === 'dark';
        let chartInstance = null;

        async function init() {
            try {
                await carregarDados();
                document.getElementById('loadingOverlay').style.display = 'none';
                aplicarTema();
                document.getElementById('currentDate').innerText = new Date().toLocaleDateString('pt-BR');
                document.getElementById('inputData').valueAsDate = new Date();
                
                // Popula Anos
                const y = new Date().getFullYear();
                [document.getElementById('resAno'), document.getElementById('histAno')].forEach(s => {
                    s.innerHTML = ''; [y, y-1].forEach(a => s.appendChild(new Option(a, a)));
                });
                
                renderTudo();
            } catch (e) { console.error(e); alert("Erro ao carregar dados."); }
        }

        async function carregarDados() {
            const [l, r, o] = await Promise.all([
                getDocs(collection(db, "lideres")),
                getDocs(collection(db, "regras")),
                getDocs(collection(db, "ocorrencias"))
            ]);
            lideres = l.docs.map(d => ({id: d.id, ...d.data()}));
            regras = r.docs.map(d => ({id: d.id, ...d.data()}));
            ocorrencias = o.docs.map(d => ({id: d.id, ...d.data()}));
            if(regras.length === 0) await criarPadrao();
        }

        async function criarPadrao() {
            const p = [
                { nome: "Reclamação", peso: 5, tipo: 'negativo', limite: 0, meta: 0, ativa: true },
                { nome: "Elogio", peso: 5, tipo: 'positivo', limite: 0, meta: 0, ativa: true },
                { nome: "Nota Limpeza", peso: 5, tipo: 'positivo', limite: 0, meta: 93, ativa: true } 
            ];
            for(const x of p) { const ref = await addDoc(collection(db, "regras"), x); regras.push({id:ref.id, ...x}); }
        }

        function renderTudo() {
            renderSelects(); renderRegras(); renderLideres(); renderHoje();
        }

        // --- GLOBAL EXPORTS ---
        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            document.getElementById(id).classList.add('active'); el.classList.add('active');
            if(id==='resultado') setTimeout(calcularResultado, 50);
            if(id==='historico') renderHistorico();
        };

        window.toggleTheme = () => { isDarkMode = !isDarkMode; localStorage.setItem('theme', isDarkMode?'dark':'light'); aplicarTema(); };
        
        window.abrirModalOcorrencia = () => { 
            document.getElementById('modalOcorrencia').style.display = 'flex'; 
            document.getElementById('divValorReal').style.display = 'none'; 
            document.getElementById('inputRegra').value = '';
            document.getElementById('descRegra').innerText = '';
            document.getElementById('checkIgnorar').checked = false; // Reset checkbox
        };
        
        window.abrirModalRegra = () => document.getElementById('modalRegra').style.display = 'flex';
        
        // Novo: Modal de Líder agora suporta edição
        window.abrirModalLider = (id = null) => { 
            const modal = document.getElementById('modalLider');
            const titulo = document.getElementById('tituloModalLider');
            const inputId = document.getElementById('editLiderId');
            const inputNome = document.getElementById('novoLiderNome');
            
            modal.style.display = 'flex';
            
            if(id) {
                // Modo Edição
                const l = lideres.find(x => x.id === id);
                titulo.innerText = "Editar Líder";
                inputId.value = id;
                inputNome.value = l.nome;
            } else {
                // Modo Criação
                titulo.innerText = "Cadastrar Líder";
                inputId.value = "";
                inputNome.value = "";
            }
        };

        window.fecharModais = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        
        window.setRegraType = t => {
            regraTipoAtual = t;
            document.getElementById('btnTypeNeg').className = `toggle-option ${t==='negativo'?'active negativo':''}`;
            document.getElementById('btnTypePos').className = `toggle-option ${t==='positivo'?'active positivo':''}`;
        };

        // --- LISTENERS ---
        document.getElementById('inputRegra').addEventListener('change', (e) => {
            const r = regras.find(x => x.id === e.target.value);
            const desc = document.getElementById('descRegra');
            const divValor = document.getElementById('divValorReal');
            
            if (!r) { desc.innerText = ''; divValor.style.display = 'none'; return; }

            if (r.meta > 0) {
                desc.innerText = `Regra de Meta: Alvo ${r.meta}. Peso: ${r.peso}`;
                divValor.style.display = 'block';
                document.getElementById('spanMetaAlvo').innerText = r.meta;
            } else {
                desc.innerText = `${r.tipo==='positivo'?'Bonificação':'Penalidade'} de ${r.peso} pts`;
                divValor.style.display = 'none';
            }
        });

        ['resLider','resAno','resPeriodo'].forEach(id=>document.getElementById(id).addEventListener('change', calcularResultado));
        ['histLider','histAno','histMes'].forEach(id=>document.getElementById(id).addEventListener('change', renderHistorico));

        // --- CRUD ---
        window.salvarOcorrencia = async () => {
            const liderId = document.getElementById('inputLider').value;
            const regraId = document.getElementById('inputRegra').value;
            const data = document.getElementById('inputData').value;
            const obs = document.getElementById('inputObs').value;
            const valorReal = document.getElementById('inputValorReal').value;
            const ignorar = document.getElementById('checkIgnorar').checked; // Captura estado do Checkbox

            if(!liderId || !regraId || !data) return alert("Preencha campos");
            
            const r = regras.find(x => x.id === regraId);
            if(r && r.meta > 0 && !valorReal) return alert("Para esta regra, informe o Valor Real atingido.");

            const nova = { 
                liderId, 
                regraId, 
                data, 
                obs, 
                valor: valorReal ? parseFloat(valorReal) : null,
                ignorar: ignorar // Salva no banco
            };
            
            try {
                const docRef = await addDoc(collection(db, "ocorrencias"), nova);
                ocorrencias.push({id:docRef.id, ...nova});
                window.fecharModais(); renderHoje();
                if(document.getElementById('historico').classList.contains('active')) renderHistorico();
                alert("Salvo!");
            } catch(e) { console.error(e); alert("Erro ao salvar."); }
        };

        window.deletarOcorrencia = async (id) => {
            if(confirm('Excluir?')) {
                await deleteDoc(doc(db, "ocorrencias", id));
                ocorrencias = ocorrencias.filter(o => o.id !== id);
                renderHoje(); 
                if(document.getElementById('historico').classList.contains('active')) renderHistorico();
            }
        };

        window.salvarRegra = async () => {
            const nome = document.getElementById('regraNome').value;
            const peso = parseFloat(document.getElementById('regraPeso').value);
            const meta = parseFloat(document.getElementById('regraMeta').value) || 0;
            const limite = parseFloat(document.getElementById('regraLimite').value) || 0;
            
            if(!nome || !peso) return;
            const nova = { nome, peso, meta, limite, tipo: regraTipoAtual, ativa: true };
            
            try {
                const docRef = await addDoc(collection(db, "regras"), nova);
                regras.push({id:docRef.id, ...nova});
                window.fecharModais(); renderRegras();
            } catch(e) { alert("Erro Regra"); }
        };

        window.toggleRegraAtiva = async (id, statusAtual) => {
            try {
                const novoStatus = !statusAtual;
                await updateDoc(doc(db, "regras", id), { ativa: novoStatus });
                const r = regras.find(x => x.id === id);
                if(r) r.ativa = novoStatus;
                renderRegras(); 
            } catch(e) { console.error(e); alert("Erro ao alterar status"); }
        };

        window.deletarRegra = async (id) => {
            if(confirm('Excluir regra permanentemente?')) {
                await deleteDoc(doc(db, "regras", id));
                regras = regras.filter(r => r.id !== id);
                renderRegras();
            }
        };

        // --- CRUD LIDERES (ATUALIZADO) ---
        window.salvarLider = async () => {
            const nome = document.getElementById('novoLiderNome').value;
            const id = document.getElementById('editLiderId').value;
            
            if(!nome) return;

            try {
                if(id) {
                    // Atualizar Existente
                    await updateDoc(doc(db, "lideres", id), { nome: nome });
                    const lider = lideres.find(l => l.id === id);
                    if(lider) lider.nome = nome;
                } else {
                    // Criar Novo
                    const docRef = await addDoc(collection(db, "lideres"), {nome});
                    lideres.push({id:docRef.id, nome});
                }
                window.fecharModais(); 
                renderLideres(); 
                renderSelects();
            } catch(e) { console.error(e); alert("Erro ao salvar líder."); }
        };

        window.deletarLider = async (id) => {
            if(confirm('Excluir líder? Isso não apaga as ocorrências dele.')) {
                await deleteDoc(doc(db, "lideres", id));
                lideres = lideres.filter(l => l.id !== id);
                renderLideres(); renderSelects();
            }
        };

        // --- RENDERS ---
        function renderHoje() {
            const c = document.getElementById('listaOcorrenciasHoje');
            const h = new Date().toISOString().split('T')[0];
            const l = ocorrencias.filter(o => o.data === h);
            c.innerHTML = '';
            document.getElementById('emptyState').style.display = l.length?'none':'block';
            
            l.forEach(o => {
                const li = lideres.find(x=>x.id===o.liderId)||{nome:'?'};
                const re = regras.find(x=>x.id===o.regraId)||{nome:'Excluída', tipo:'negativo'};
                
                let txtExtra = '';
                if(o.valor !== null && o.valor !== undefined) txtExtra += ` (Nota: ${o.valor})`;
                if(o.ignorar) txtExtra += ` <span style="color:var(--text-secondary)">[Sem Pts]</span>`;

                c.innerHTML += `
                <div class="card" style="padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${li.nome}</strong>
                        <div style="font-size:14px; color:var(--text-secondary)">
                            <span style="color:${re.tipo==='negativo'?'var(--danger)':'var(--success)'}">${re.nome}</span>
                            ${txtExtra} ${o.obs?'- '+o.obs:''}
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deletarOcorrencia('${o.id}')"><i class="fas fa-trash"></i></button>
                </div>`;
            });
        }

        function renderRegras() {
            const t = document.querySelector('#tabelaRegras tbody'); t.innerHTML = '';
            regras.forEach(r => {
                const status = r.ativa !== false; 
                const txtMeta = r.meta > 0 ? `<br><small style="color:var(--primary)">Meta: ${r.meta}</small>` : '';
                const txtTipo = r.meta > 0 ? 'Híbrido' : (r.tipo === 'positivo' ? 'Bônus' : 'Pena');
                
                t.innerHTML += `
                <tr style="opacity: ${status ? 1 : 0.5}">
                    <td>
                        <label class="switch">
                            <input type="checkbox" ${status ? 'checked' : ''} onchange="toggleRegraAtiva('${r.id}', ${status})">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>${r.nome}${txtMeta}</td>
                    <td>${txtTipo}</td>
                    <td>${r.peso}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deletarRegra('${r.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
            const s = document.getElementById('inputRegra'); s.innerHTML = '<option value="">Selecione...</option>';
            regras.filter(r => r.ativa !== false).forEach(r => s.appendChild(new Option(r.nome, r.id)));
        }

        function renderHistorico() {
            const lid = document.getElementById('histLider').value;
            const ano = parseInt(document.getElementById('histAno').value);
            const mes = document.getElementById('histMes').value;
            const c = document.getElementById('listaHistorico');
            c.innerHTML = '';
            
            if(!lid) { document.getElementById('emptyStateHist').style.display='block'; return; }

            const lista = ocorrencias.filter(o => {
                const p = o.data.split('-');
                let matchM = mes === 'todos' ? true : parseInt(p[1]) == mes;
                return o.liderId === lid && parseInt(p[0]) === ano && matchM;
            }).sort((a,b) => new Date(b.data)-new Date(a.data));

            document.getElementById('emptyStateHist').style.display = lista.length?'none':'block';

            lista.forEach(o => {
                const re = regras.find(x=>x.id===o.regraId)||{nome:'?', peso:0};
                let classe = 'bg-danger', sinal = '-', txtValor = '', pesoShow = re.peso;
                
                if (o.ignorar) {
                    // SE ESTIVER IGNORADO (Desativado Penalidade)
                    classe = 'bg-gray'; sinal = ''; pesoShow = 0; txtValor = " (Ignorado)";
                } else if (re.meta > 0) {
                    const atingiu = (o.valor >= re.meta);
                    classe = atingiu ? 'bg-success' : 'bg-danger';
                    sinal = atingiu ? '+' : '-';
                    txtValor = ` | Nota: ${o.valor}`;
                } else {
                    classe = re.tipo === 'positivo' ? 'bg-success' : 'bg-danger';
                    sinal = re.tipo === 'positivo' ? '+' : '-';
                }

                c.innerHTML += `
                <div class="card" style="padding:15px; margin-bottom:10px; display:flex; justify-content:space-between;">
                    <div>
                        <span class="history-date">${new Date(o.data).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</span>
                        <div>
                            <b>${re.nome}</b>
                            <span class="badge-points ${classe}">${sinal}${pesoShow} pts</span>
                            <small>${txtValor}</small>
                        </div>
                        ${o.obs ? `<small style="color:var(--text-secondary)">${o.obs}</small>` : ''}
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deletarOcorrencia('${o.id}')"><i class="fas fa-trash"></i></button>
                </div>`;
            });
        }

        function calcularResultado() {
            const lid = document.getElementById('resLider').value;
            const ano = parseInt(document.getElementById('resAno').value);
            const per = document.getElementById('resPeriodo').value;
            if(!lid) return;

            const meta = per==='anual' ? 1200 : 100;
            document.getElementById('displayMeta').innerText = `Meta: ${meta}`;
            
            let total = 0, labels = [], data = [], colors = [];
            const tb = document.querySelector('#tabelaExtrato tbody'); tb.innerHTML = '';
            const ms = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

            if(per==='anual') {
                let det = {};
                for(let i=1; i<=12; i++) {
                    const r = calcMes(lid, i, ano);
                    total += r.nota;
                    labels.push(ms[i-1]); data.push(r.nota);
                    colors.push(r.nota>=90?'#10b981':(r.nota>=70?'#f59e0b':'#ef4444'));
                    r.det.forEach(d => {
                        if(!det[d.nome]) det[d.nome]={qtd:0,imp:0};
                        det[d.nome].qtd += d.qtd; det[d.nome].imp += d.imp;
                    });
                }
                for(const [k,v] of Object.entries(det)) addLinha(tb, k, v.qtd, v.imp);
            } else {
                const m = parseInt(per);
                const r = calcMes(lid, m, ano);
                total = r.nota;
                labels=[ms[m-1]]; data=[total]; colors=[total>=90?'#10b981':(total>=70?'#f59e0b':'#ef4444')];
                r.det.forEach(d => addLinha(tb, d.nome, d.qtd, d.imp));
            }

            const el = document.getElementById('displayPontos'); el.innerText = Math.round(total);
            const pct = total/meta;
            el.style.color = pct>=0.9?'var(--success)':(pct>=0.7?'var(--warning)':'var(--danger)');
            renderChart(labels, data, colors, meta);
        }

        function calcMes(lid, m, a) {
            let nota = 100, det = [];
            const regrasAtivas = regras.filter(r => r.ativa !== false);
            
            const lista = ocorrencias.filter(o => {
                const p = o.data.split('-'); return o.liderId === lid && parseInt(p[1])===m && parseInt(p[0])===a;
            });

            regrasAtivas.forEach(r => {
                // Filtra ocorrências desta regra E que NÃO estão marcadas como "ignorar"
                const occs = lista.filter(o => o.regraId === r.id && !o.ignorar);
                
                if(occs.length > 0) {
                    let impactoTotal = 0;
                    
                    if (r.meta > 0) {
                        occs.forEach(o => {
                            if (o.valor >= r.meta) impactoTotal += r.peso;
                            else impactoTotal -= r.peso;
                        });
                    } else {
                        let qtd = occs.length;
                        if(r.limite > 0) qtd = Math.max(0, qtd - r.limite);
                        
                        if(r.tipo === 'positivo') impactoTotal = qtd * r.peso;
                        else impactoTotal = -(qtd * r.peso);
                    }

                    nota += impactoTotal;
                    det.push({nome: r.nome, qtd: occs.length, imp: impactoTotal});
                }
            });
            return { nota: Math.max(0, nota), det };
        }

        function addLinha(t, n, q, i) {
            t.innerHTML += `<tr><td>${n}</td><td>${q}</td><td style="color:${i>=0?'var(--success)':'var(--danger)'};font-weight:bold">${i>0?'+':''}${i}</td></tr>`;
        }

        function renderChart(l, d, c, max) {
            const ctx = document.getElementById('graficoResultado').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            const clr = isDarkMode?'#cbd5e1':'#475569';
            chartInstance = new Chart(ctx, {
                type:'bar',
                data:{labels:l, datasets:[{data:d, backgroundColor:c, borderRadius:6, datalabels:{color:clr, anchor:'end', align:'top', formatter:Math.round, font:{weight:'bold'}}}]},
                options:{responsive:true, maintainAspectRatio:false, layout:{padding:{top:25}}, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, max:max===1200?150:130, ticks:{color:clr}, grid:{color:isDarkMode?'#334155':'#e2e8f0'}}, x:{ticks:{color:clr}, grid:{display:false}}}}
            });
        }

        // --- RENDER LIDERES (AGORA COM BOTÕES DE AÇÃO) ---
        function renderLideres() { 
            const d=document.getElementById('listaLideresGerenciar'); d.innerHTML=''; 
            lideres.forEach(l => {
                d.innerHTML += `
                <div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                    <span>${l.nome}</span>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-sm btn-warning" onclick="abrirModalLider('${l.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deletarLider('${l.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
        }

        function renderSelects() {
            [document.getElementById('inputLider'), document.getElementById('resLider'), document.getElementById('histLider')].forEach(s => {
                const v = s.value; s.innerHTML='<option value="">Selecione...</option>';
                lideres.forEach(l=>s.appendChild(new Option(l.nome, l.id))); s.value=v;
            });
        }

        function aplicarTema() {
            const b=document.body, i=document.querySelector('.fab-theme i');
            if(isDarkMode){ b.classList.add('dark-mode'); i.className='fas fa-sun'; }
            else{ b.classList.remove('dark-mode'); i.className='fas fa-moon'; }
        }

        init();
    </script>
</body>
</html>